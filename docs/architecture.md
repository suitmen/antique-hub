# Архитектура AntiqueHub

## Общая архитектура

AntiqueHub следует архитектуре клиент-сервер с разделением на фронтенд и бэкенд.

```
┌─────────────────┐    HTTP    ┌──────────────────┐
│   Frontend      │ ──────────▶│    Backend       │
│   (React)       │            │   (FastAPI)      │
└─────────────────┘            └──────────────────┘
                                        │
                                        │ Database
                                        ▼
                              ┌──────────────────┐
                              │  PostgreSQL      │
                              │   Database       │
                              └──────────────────┘
```

## Бэкенд (FastAPI)

### Основные компоненты

1. **Основное приложение** (`main.py`)
   - Точка входа в приложение
   - Настройка middleware
   - Определение routes

2. **Модели данных** (`models.py`)
   - Определение структуры базы данных с помощью SQLAlchemy
   - Связи между таблицами

3. **Схемы** (`schemas.py`)
   - Pydantic модели для валидации данных
   - Определение форматов запросов и ответов

4. **CRUD операции** (`crud.py`)
   - Функции для работы с базой данных
   - Создание, чтение, обновление, удаление записей

5. **Аутентификация** (`auth.py`)
   - Регистрация и вход пользователей
   - Генерация и проверка JWT токенов

6. **Платежи** (`payments/`)
   - Интеграция с ЮKassa и Stripe
   - Фабрика для выбора платежной системы

### Структура базы данных

#### Таблица пользователей (`users`)
- `id`: уникальный идентификатор
- `email`: email пользователя (уникальный)
- `hashed_password`: хешированный пароль
- `is_seller`: флаг продавца
- `verified`: флаг верификации
- `role`: роль пользователя (buyer, seller, admin)
- `created_at`: дата создания

#### Таблица лотов (`lots`)
- `id`: уникальный идентификатор
- `title`: название лота
- `description`: описание лота
- `price`: цена
- `currency`: валюта
- `category`: категория
- `era`: эпоха
- `material`: материал
- `image_urls`: URL изображений (JSON)
- `is_approved`: флаг одобрения модератором
- `status`: статус лота (pending, approved, rejected)
- `seller_id`: ссылка на продавца
- `created_at`: дата создания

#### Таблица заказов (`orders`)
- `id`: уникальный идентификатор
- `item_id`: ссылка на лот
- `buyer_id`: ссылка на покупателя
- `status`: статус заказа (created, paid, shipped, cancelled)
- `payment_id`: идентификатор платежа
- `payment_provider`: провайдер платежа (yookassa, stripe)
- `created_at`: дата создания

#### Таблица тикетов поддержки (`support_tickets`)
- `id`: уникальный идентификатор
- `user_id`: ссылка на пользователя
- `subject`: тема тикета
- `message`: сообщение
- `category`: категория (payment, item, account, delivery)
- `order_id`: ссылка на заказ (опционально)
- `status`: статус тикета (new, in_progress, resolved, closed)
- `created_at`: дата создания

## Фронтенд (React)

### Основные компоненты

1. **Страницы**
   - `Home` - главная страница
   - `Login` - страница входа
   - `Register` - страница регистрации
   - `LotList` - список лотов
   - `LotDetail` - детали лота
   - `CreateLot` - создание лота
   - `Profile` - профиль пользователя
   - `Support` - техподдержка

2. **Компоненты**
   - `Header` - навигационная панель
   - `LotCard` - карточка лота

3. **Стили**
   - CSS модули для каждого компонента
   - Общие стили в `App.css`

## Docker

### Сервисы

1. **База данных** (`db`)
   - PostgreSQL 15
   - Персистентное хранение данных в volume

2. **Бэкенд** (`backend`)
   - Python 3.11 с FastAPI
   - Автоматическое создание таблиц при запуске

3. **Фронтенд** (`frontend`)
   - Node.js 18
   - Сборка React приложения

### Сети и тома

- `antiquehub_network` - bridge сеть для взаимодействия сервисов
- `postgres_data` - volume для хранения данных базы данных

## Безопасность

### Аутентификация
- JWT токены для аутентификации пользователей
- Хеширование паролей с помощью bcrypt

### Защита API
- CORS middleware
- Валидация входных данных
- Ограничение количества запросов (rate limiting)

### Безопасность платежей
- Интеграция с проверенными платежными системами
- Использование webhook для подтверждения платежей
- Соответствие требованиям 54-ФЗ для чеков

## Масштабируемость

### Горизонтальное масштабирование
- Возможность запуска нескольких инстансов бэкенда
- Балансировка нагрузки через reverse proxy

### Вертикальное масштабирование
- Увеличение ресурсов для каждого сервиса
- Оптимизация запросов к базе данных

### Паттерны для масштабирования
- Использование кэширования (Redis)
- Асинхронная обработка задач (Celery)
- Разделение базы данных на чтение/запись